---
# playbooks/install-jenkins.yml
# Version corrig√©e - Installation Jenkins avec Java 21

- name: Installation compl√®te de Jenkins sur Ubuntu/Debian
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    jenkins_initial_admin_password_file: /var/lib/jenkins/secrets/initialAdminPassword
    
  pre_tasks:
    - name: Afficher les informations du serveur
      debug:
        msg:
          - "========================================="
          - "Serveur: {{ ansible_hostname }}"
          - "IP Priv√©e: {{ ansible_default_ipv4.address }}"
          - "IP Publique: {{ public_ip | default('N/A') }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Architecture: {{ ansible_architecture }}"
          - "CPU: {{ ansible_processor_vcpus }} cores"
          - "RAM: {{ ansible_memtotal_mb }} MB"
          - "========================================="
      tags: [always]
    
  tasks:
    # ==========================================
    # √âTAPE 1 : MISE √Ä JOUR DU SYST√àME
    # ==========================================
    - name: Mise √† jour du cache APT
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [system, update]
    
    # ==========================================
    # √âTAPE 2 : INSTALLATION DE JAVA 21
    # ==========================================
    - name: Installer Java 21 et ses d√©pendances
      apt:
        name:
          - fontconfig
          - openjdk-21-jre
        state: present
        update_cache: yes
      tags: [java]
    
    - name: V√©rifier l'installation de Java
      command: java -version
      register: java_version_output
      changed_when: false
      tags: [java, verify]
    
    - name: Afficher la version de Java
      debug:
        msg: 
          - "Java install√© avec succ√®s !"
          - "Version: {{ java_version_output.stderr_lines[0] if java_version_output.stderr_lines else 'Non disponible' }}"
      tags: [java, verify]
    
    # ==========================================
    # √âTAPE 3 : INSTALLATION DE GIT
    # ==========================================
    - name: Installer Git et outils associ√©s
      apt:
        name:
          - git
          - git-lfs
        state: present
      tags: [git]
    
    - name: V√©rifier la version de Git
      command: git --version
      register: git_version_output
      changed_when: false
      tags: [git, verify]
    
    - name: Afficher la version de Git
      debug:
        msg: "Git install√© : {{ git_version_output.stdout }}"
      tags: [git, verify]
    
    # ==========================================
    # √âTAPE 4 : INSTALLATION DES OUTILS DE DEV
    # ==========================================
    - name: Installer les outils de d√©veloppement
      apt:
        name:
          - curl
          - wget
          - vim
          - nano
          - unzip
          - zip
        state: present
      tags: [tools]
    
    # ==========================================
    # √âTAPE 5 : CONFIGURATION DU D√âP√îT JENKINS
    # ==========================================
    - name: Cr√©er le r√©pertoire pour les keyrings APT
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      tags: [jenkins, repo]
    
    - name: T√©l√©charger la cl√© GPG de Jenkins
      get_url:
        url: "https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key"
        dest: "/etc/apt/keyrings/jenkins-keyring.asc"
        mode: '0644'
      tags: [jenkins, repo]
    
    - name: Ajouter le d√©p√¥t Jenkins
      copy:
        content: "deb [signed-by=/etc/apt/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/"
        dest: "/etc/apt/sources.list.d/jenkins.list"
        mode: '0644'
      tags: [jenkins, repo]
    
    - name: Mettre √† jour le cache APT apr√®s ajout du d√©p√¥t
      apt:
        update_cache: yes
      tags: [jenkins, repo]
    
    # ==========================================
    # √âTAPE 6 : INSTALLATION DE JENKINS
    # ==========================================
    - name: Installer Jenkins
      apt:
        name: jenkins
        state: present
      register: jenkins_installed
      tags: [jenkins, install]
    
    - name: Cr√©er le r√©pertoire de configuration Jenkins service
      file:
        path: /etc/systemd/system/jenkins.service.d
        state: directory
        mode: '0755'
      tags: [jenkins, config]
    
    - name: Configurer les options Java pour Jenkins
      copy:
        content: |
          [Service]
          Environment="JAVA_OPTS=-Djava.awt.headless=true -Djenkins.install.runSetupWizard=false"
          Environment="JENKINS_PORT={{ jenkins_http_port | default(8080) }}"
        dest: /etc/systemd/system/jenkins.service.d/override.conf
        mode: '0644'
      notify: restart jenkins
      tags: [jenkins, config]
    
    # ==========================================
    # √âTAPE 7 : D√âMARRAGE DE JENKINS
    # ==========================================
    - name: Recharger systemd
      systemd:
        daemon_reload: yes
      tags: [jenkins, service]
    
    - name: D√©marrer et activer Jenkins
      systemd:
        name: jenkins
        state: started
        enabled: yes
      tags: [jenkins, service]
    
    - name: Attendre que Jenkins soit pr√™t
      wait_for:
        port: "{{ jenkins_http_port | default(8080) }}"
        host: "{{ ansible_default_ipv4.address }}"
        delay: 20
        timeout: 120
      tags: [jenkins, service]
    
    # ==========================================
    # √âTAPE 8 : R√âCUP√âRATION DU MOT DE PASSE
    # ==========================================
    - name: Attendre que le fichier de mot de passe soit cr√©√©
      wait_for:
        path: "{{ jenkins_initial_admin_password_file }}"
        state: present
        timeout: 60
      tags: [jenkins, password]
    
    - name: Lire le mot de passe administrateur initial
      slurp:
        src: "{{ jenkins_initial_admin_password_file }}"
      register: admin_password
      tags: [jenkins, password]
    
    - name: Afficher le mot de passe
      debug:
        msg: "Mot de passe initial Jenkins : {{ admin_password.content | b64decode | trim }}"
      tags: [jenkins, password]
    
    # ==========================================
    # √âTAPE 9 : INSTALLATION DE DOCKER (OPTIONNEL)
    # ==========================================
    - name: Installer les pr√©requis Docker
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
      when: install_docker | default(true)
      tags: [docker]
    
    - name: Ajouter la cl√© GPG Docker
      get_url:
        url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
      when: install_docker | default(true)
      tags: [docker]
    
    - name: Ajouter le d√©p√¥t Docker
      apt_repository:
        repo: "deb [arch={{ ansible_architecture | replace('x86_64', 'amd64') }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
      when: install_docker | default(true)
      tags: [docker]
    
    - name: Installer Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: yes
      when: install_docker | default(true)
      tags: [docker]
    
    - name: Ajouter les utilisateurs au groupe docker
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop:
        - admin
        - jenkins
      when: install_docker | default(true)
      ignore_errors: yes
      tags: [docker]
    
    - name: D√©marrer et activer Docker
      systemd:
        name: docker
        state: started
        enabled: yes
      when: install_docker | default(true)
      tags: [docker]
    
    # ==========================================
    # √âTAPE 10 : OUTILS DE MONITORING
    # ==========================================
    - name: Installer les outils de monitoring
      apt:
        name:
          - htop
          - nethogs
          - iotop
        state: present
      when: enable_monitoring | default(true)
      ignore_errors: yes
      tags: [monitoring]
    
  handlers:
    - name: restart jenkins
      systemd:
        name: jenkins
        state: restarted
        daemon_reload: yes
    
  post_tasks:
    - name: Afficher les informations d'acc√®s
      debug:
        msg:
          - "========================================="
          - "üéâ INSTALLATION TERMIN√âE AVEC SUCC√àS !"
          - "========================================="
          - ""
          - "üìå Acc√®s Jenkins :"
          - "   URL : http://{{ public_ip | default(ansible_default_ipv4.address) }}:{{ jenkins_http_port | default(8080) }}"
          - "   Username : admin"
          - "   Password : {{ admin_password.content | b64decode | trim if admin_password is defined else 'Voir le fichier /var/lib/jenkins/secrets/initialAdminPassword' }}"
          - ""
          - "üìã Versions install√©es :"
          - "   Java : OpenJDK 21"
          - "   Jenkins : Latest LTS"
          - "   Git : {{ git_version_output.stdout if git_version_output is defined else 'Install√©' }}"
          - ""
          - "üìù Prochaines √©tapes :"
          - "   1. Acc√©dez √† Jenkins via votre navigateur"
          - "   2. Utilisez le mot de passe initial"
          - "   3. Installez les plugins sugg√©r√©s"
          - "   4. Cr√©ez votre utilisateur admin"
          - "========================================="
      tags: [always]
