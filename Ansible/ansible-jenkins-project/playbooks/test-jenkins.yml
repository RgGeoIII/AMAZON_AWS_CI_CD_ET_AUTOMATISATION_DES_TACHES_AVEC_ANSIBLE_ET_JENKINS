---
# playbooks/test-jenkins.yml
# Tests de validation apr√®s installation

- name: Tests de validation Jenkins
  hosts: jenkins
  become: yes
  gather_facts: yes
  
  tasks:
    # ==========================================
    # TEST 1 : V√âRIFICATION JAVA
    # ==========================================
    - name: Test - Version Java
      command: java -version
      register: java_test
      changed_when: false
      failed_when: false
      tags: [test, java]
    
    - name: Valider Java 21
      assert:
        that:
          - java_test.rc == 0
          - "'openjdk version \"21' in java_test.stderr or 'openjdk 21' in java_test.stderr"
        fail_msg: " Java 21 n'est pas install√© correctement"
        success_msg: " Java 21 est correctement install√©"
      tags: [test, java]
    
    # ==========================================
    # TEST 2 : V√âRIFICATION GIT
    # ==========================================
    - name: Test - Version Git
      command: git --version
      register: git_test
      changed_when: false
      failed_when: false
      tags: [test, git]
    
    - name: Valider Git
      assert:
        that:
          - git_test.rc == 0
          - "'git version' in git_test.stdout"
        fail_msg: " Git n'est pas install√©"
        success_msg: "Git est correctement install√©"
      tags: [test, git]
    
    # ==========================================
    # TEST 3 : V√âRIFICATION JENKINS SERVICE
    # ==========================================
    - name: Test - Statut du service Jenkins
      systemd:
        name: jenkins
      register: jenkins_service
      tags: [test, jenkins]
    
    - name: Valider le service Jenkins
      assert:
        that:
          - jenkins_service.status.ActiveState == "active"
          - jenkins_service.status.SubState == "running"
        fail_msg: " Le service Jenkins n'est pas actif"
        success_msg: " Le service Jenkins est actif et en cours d'ex√©cution"
      tags: [test, jenkins]
    
    # ==========================================
    # TEST 4 : V√âRIFICATION PORT JENKINS
    # ==========================================
    - name: Test - Port Jenkins en √©coute
      wait_for:
        port: "{{ jenkins_http_port | default(8080) }}"
        host: 127.0.0.1
        timeout: 10
      register: port_test
      ignore_errors: yes
      tags: [test, jenkins, port]
    
    - name: Valider le port Jenkins
      assert:
        that:
          - port_test is succeeded
        fail_msg: " Jenkins n'√©coute pas sur le port {{ jenkins_http_port | default(8080) }}"
        success_msg: " Jenkins √©coute sur le port {{ jenkins_http_port | default(8080) }}"
      tags: [test, jenkins, port]
    
    # ==========================================
    # TEST 5 : V√âRIFICATION HTTP JENKINS
    # ==========================================
    - name: Test - Acc√®s HTTP √† Jenkins
      uri:
        url: "http://127.0.0.1:{{ jenkins_http_port | default(8080) }}"
        status_code: [200, 403]
        timeout: 10
      register: http_test
      ignore_errors: yes
      tags: [test, jenkins, http]
    
    - name: Valider l'acc√®s HTTP
      assert:
        that:
          - http_test is succeeded
          - http_test.status in [200, 403]
        fail_msg: " L'interface web Jenkins n'est pas accessible"
        success_msg: " L'interface web Jenkins est accessible"
      tags: [test, jenkins, http]
    
    # ==========================================
    # TEST 6 : V√âRIFICATION DOCKER (SI INSTALL√â)
    # ==========================================
    - name: Test - Docker install√©
      command: docker --version
      register: docker_test
      changed_when: false
      failed_when: false
      when: install_docker | default(true)
      tags: [test, docker]
    
    - name: Valider Docker
      assert:
        that:
          - docker_test.rc == 0
          - "'Docker version' in docker_test.stdout"
        fail_msg: " Docker n'est pas install√© correctement"
        success_msg: " Docker est correctement install√©"
      when: install_docker | default(true)
      tags: [test, docker]
    
    # ==========================================
    # TEST 7 : FICHIER MOT DE PASSE INITIAL
    # ==========================================
    - name: Test - Pr√©sence du fichier de mot de passe initial
      stat:
        path: /var/lib/jenkins/secrets/initialAdminPassword
      register: password_file
      tags: [test, jenkins, password]
    
    - name: Valider le fichier de mot de passe
      assert:
        that:
          - password_file.stat.exists
          - password_file.stat.size > 0
        fail_msg: " Le fichier de mot de passe initial n'existe pas"
        success_msg: " Le fichier de mot de passe initial est pr√©sent"
      tags: [test, jenkins, password]
    
    # ==========================================
    # TEST 8 : V√âRIFICATION M√âMOIRE
    # ==========================================
    - name: Test - M√©moire disponible
      shell: free -m | grep Mem | awk '{print $7}'
      register: available_memory
      changed_when: false
      tags: [test, system]
    
    - name: Valider la m√©moire disponible
      assert:
        that:
          - available_memory.stdout | int > 100
        fail_msg: "M√©moire disponible faible : {{ available_memory.stdout }} MB"
        success_msg: "M√©moire disponible suffisante : {{ available_memory.stdout }} MB"
      tags: [test, system]
    
    # ==========================================
    # TEST 9 : V√âRIFICATION ESPACE DISQUE
    # ==========================================
    - name: Test - Espace disque disponible
      shell: df -h / | tail -1 | awk '{print $4}' | sed 's/G//'
      register: disk_space
      changed_when: false
      tags: [test, system]
    
    - name: Valider l'espace disque
      assert:
        that:
          - disk_space.stdout | float > 1.0
        fail_msg: " Espace disque faible : {{ disk_space.stdout }}G"
        success_msg: "Espace disque suffisant : {{ disk_space.stdout }}G"
      ignore_errors: yes
      tags: [test, system]
    
    # ==========================================
    # R√âSUM√â DES TESTS
    # ==========================================
    - name: Collecter les r√©sultats des tests
      set_fact:
        test_results:
          - "Java 21 :  Install√©"
          - "Git :  Install√©"
          - "Jenkins Service :  Actif"
          - "Port {{ jenkins_http_port | default(8080) }} :  En √©coute"
          - "Interface Web :  Accessible"
          - "Docker : {{ 'Install√©' if (install_docker | default(true)) else ' Skipped' }}"
          - "Mot de passe initial :  Disponible"
      tags: [test, summary]
    
    - name: Afficher le r√©sum√© des tests
      debug:
        msg:
          - "========================================="
          - "üìäR√âSUM√â DES TESTS"
          - "========================================="
          - "{{ test_results }}"
          - "========================================="
          - ""
          - " Tous les tests sont pass√©s avec succ√®s !"
          - ""
          - " Acc√®s Jenkins :"
          - "   URL externe : http://{{ public_ip | default(ansible_default_ipv4.address) }}:{{ jenkins_http_port | default(8080) }}"
          - "   URL locale : http://{{ ansible_default_ipv4.address }}:{{ jenkins_http_port | default(8080) }}"
          - ""
          - " Pour r√©cup√©rer le mot de passe :"
          - "   sudo cat /var/lib/jenkins/secrets/initialAdminPassword"
          - "========================================="
      tags: [test, summary, always]‚èé    
